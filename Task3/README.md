# Task3
## Проблематика взаимодействий
- Есть единый интеграционный сервис ins-product-aggregator для получения данных от всех страховых компаний (5 шт.). Получение данных в нем происходит синхронно, после чего данные агрегируются и возвращаются запрашивающему.
- Сервисы источники запросов core-app (раз в 15 мин) и ins-comp-settlement (раз в сутки) отправляют запросы синхронно по своей бизнес-логике и могут сделать это одновременно. Также ins-comp-settlement вызывает core-app, который для ответа возможно вызывает ins-product-aggregator.
- API страховых компаний почти наверняка имеют лимиты на запросы, при одновременном обращении часть запросов упадет в 429 Too many requests
- Планируется увеличить кол-во интегрированных страховых компаний х2, что соответственно увеличит время выполнения запросов ins-product-aggregator и потенциально приведет к росту ошибок 408 Request Timeout или 504 Gateway Timeout

## Решение 1 (отображено на C4 диаграмме)
Исходим из запрета на переделываение бизнес-логки, и из того, что данные от страховых компаний core-app и ins-comp-settlement нужны разные.
- Предлагается перейти в части запросов данных из страховых компаний на асинхронный подход через брокера.
- В качестве брокера для отправки команд и получения ответов можно выбрать Apache ActiveMQ (дорогой вариант для потенциально высокой нагрузки) или RabbitMQ (более чем достаточен для настоящего кейса при околонулевых RPS).
- Также во взаимодействии ins-comp-settlement с core-app предлагается перейти от отправки команд на подписку на события из сервиса core-app, то есть при оформлении новой страховки отправлять об этом событие в брокера и читать его в ins-comp-settlement. Для этого больше в качестве брокера подойдет Apache Kafka.
- При построении асинхронного взаимодействия сервисов с ins-product-aggregator скорее всего будет иметь смысл применить паттерн Transactional Outbox для сохранения в БД записи об инициализации команды с ее id и отправки в брокера непосредственно сообщения.

## Решение 2 (альтернативное, не отображено на C4)
Если данные от страховых компаний сервисам нужны одинаковые и допустимо небольшое изменение логики, то предлагается перейти на одного инициатора запроса данных и подписку на события всех интересантов.
- Сервис ins-product-aggregator самостоятельно раз в необходимый период запрашивает данные у страховых компаний.
- После агрегации полученных данных сервис ins-product-aggregator кладет событие обновления данных в Apache Kafka.
- Сервисы core-app, ins-comp-settlement и любые другие подписанные на топик забирают данные от страховых компаний и обновляют в своем локальном хранилище.
- Из решения 1 также остается: во взаимодействии ins-comp-settlement с core-app предлагается перейти от отправки команд на подписку на события из сервиса core-app, то есть при оформлении новой страховки отправлять об этом событие в брокера и читать его в ins-comp-settlement.
